<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no,
		shrink-to-fit=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

  <title>Labb 4</title>

  <style>
    /* @import "ui/css/evothings-app.css"; */
  </style>

  <script>
    // Redirect console.log to Evothings Workbench.
    // if (window.hyper && window.hyper.log) {
    //   console.log = hyper.log;
    // }
  </script>

  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.21.7.js"></script>
  <!-- <script src="libs/jquery/jquery.js"></script> -->

  <!-- Instantiate PubNub -->

  <script type="text/javascript">
    // $("#firstpage").show();
    // $("#chatroom").hide();
    let username = "UNKNOWN";
    let activeRoom = "north";

    enterChatroom = (e) => {
      e.preventDefault();
      username = document.getElementById("username").value;
      // $("#firstpage").hide();
      // $("#chatroom").show();
    }

    var pubnub = new PubNub({
      publishKey: "pub-c-c42f11f2-1108-438a-ae06-bfe3787a8131",
      subscribeKey: "sub-c-ca7b08c8-67f5-11e9-81d5-56c3556875f9"
    });


    // Subscribe to the demo_tutorial channel pubnub
    pubnub.addListener({
      message: function (message) {
        alert("hello")
        let newMessage = document.createElement('p');
        newMessage.innerHTML = "From: " + message.message.from + "<br />" + message.message.message;
        document.getElementById("messages").appendChild(newMessage);
      }
    });

    subscribeToChannel = direction => {
      // // Unsubbar till alla kanaler
      // var channels = ["North", "East", "West", "South"];
      // let result = channels.filter(index => index != direction);

      // pubnub.unsubscribe({
      //   channels: result
      // });

      document.getElementById("active_room").innerHTML = direction;
      document.getElementById("subroom").innerHTML = direction;
      activeRoom = direction;

      // DET ÄR DETTA SOM FUCKAR SÖNDER!!! DET GÅR INTE ATT ÄNDRA SUBSCRIBE I EN FUNKTION?
      // pubnub.subscribe({
      //   channels: [activeRoom]
      // });
    };

    // pubnub.subscribe({
    //   channels: [activeRoom]
    // });

    sendMessage = (e) => {
      // Publish a simple message to the “demo_tutorial” channel pubnub:
      e.preventDefault();
      let direction = document.getElementById("active_room").innerText;
      document.getElementById("room").innerText = direction;

      pubnub.subscribe({
        channels: [direction]
      });

      let message = document.getElementById("new-message").value;
      pubnub.publish({
        message: { "from": username, "message": message },
        channel: [direction]
      });
    }
  </script>

  <script>
    var output = document.querySelector('.output');
    // // Get event data
    function deviceOrientationListener(event) {
      let element = document.getElementById("orientation");
      var alpha = event.alpha; //z axis rotation [0,360)
      var beta = event.beta; //x axis rotation [-180, 180]
      var gamma = event.gamma; //y axis rotation [-90, 90]
      element.innerHTML = "Alpha: " + event.alpha.toFixed([0]) + "<br/> Beta: " + event.beta.toFixed([0]) + "<br/> Gamma: " + event.gamma.toFixed([0]);

      if (alpha.toFixed([0]) > 315 || alpha.toFixed([0]) < 45) {
        subscribeToChannel("North");
      } else if (alpha.toFixed([0]) > 45 && alpha.toFixed([0]) < 135) {
        subscribeToChannel("West");
      } else if (alpha.toFixed([0]) > 135 && alpha.toFixed([0]) < 225) {
        subscribeToChannel("South");
      } else if (alpha.toFixed([0]) > 225 && alpha.toFixed([0]) < 314) {
        subscribeToChannel("East");
      }
    }

    if (window.DeviceOrientationEvent) {
      window.addEventListener("deviceorientation", deviceOrientationListener, true);

    } else {
      alert("Doesn't work!");
    }

  </script>


</head>

<body ontouchstart="">
  <div id="firstpage">
    <h1>Welcome to Chat Along</h1>
    <h2>You join channels by pointing your mobilephone towards specific directions. <i>North, </i><i>East,
      </i><i>South, </i><i>West</i></h2>
    <h4>Please enter username to start chatting</h4>
    <form onsubmit="enterChatroom(event)">
      <input type="text" placeholder="Enter username!" id="username" name="username" />
      <button type="submit">Select</button>
      <!-- sssssss -->
      <p>Version 6</p>
      <p>Send message to: <i id="room"></i></p>
      <p>Subscribe to: <i id="subroom"></i></p>

      <p id="orientation"></p>
      <p id="heading"></p>
      <h2>This is room, <i id="active_room"></i></h2>
    </form>
  </div>

  <div id="chatroom">
    <h2>Messages:</h2>
    <form onsubmit="sendMessage(event)">
      <!-- <input type="text" placeholder="Who is sending the message?" name="from" id="from" /> -->
      <input type="text" placeholder="Write message!" name="new-message" id="new-message" />
      <button type="submit">
        Send message!
      </button>
    </form>

    <div id="messageDiv">
      <p id="messages"></p>
    </div>
  </div>

  <script src="cordova.js"></script>
  <script src="libs/evothings/evothings.js"></script>
  <script src="libs/evothings/ui/ui.js"></script>
</body>

</html>