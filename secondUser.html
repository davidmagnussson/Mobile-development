<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no,
		shrink-to-fit=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"
    />

    <title>Labb 4</title>

    <style>
      /* @import "ui/css/evothings-app.css"; */
    </style>

    <script>
      // Redirect console.log to Evothings Workbench.
      // if (window.hyper && window.hyper.log) {
      //   console.log = hyper.log;
      // }
    </script>

    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.21.7.js"></script>
    <!-- <script src="libs/jquery/jquery.js"></script> -->

    <!-- Instantiate PubNub -->

    <script type="text/javascript">
      // $("#firstpage").show();
      // $("#chatroom").hide();
      let username = "UNKNOWN";
      let test = "";

      enterChatroom = e => {
        e.preventDefault();
        username = document.getElementById("username").value;
        // $("#firstpage").hide();
        // $("#chatroom").show();
      };

      var pubnub = new PubNub({
        publishKey: "pub-c-c42f11f2-1108-438a-ae06-bfe3787a8131",

        subscribeKey: "sub-c-ca7b08c8-67f5-11e9-81d5-56c3556875f9"
      });

      // Subscribe to the demo_tutorial channel pubnub
      pubnub.addListener({
        message: function(message) {
          let newMessage = document.createElement("p");
          newMessage.innerHTML =
            "From: " +
            message.message.from +
            "<br />" +
            message.message.message;
          document.getElementById("messages").appendChild(newMessage);
          // document.getElementById("message").innerHTML = message_array;
          // document.getElementById("publisher").innerHTML = message.message.from;
        }
      });

      subscribeToChannel = direction => {
        // Unsubbar till alla kanaler

        pubnub.unsubscribe({
          channels: ["North", "East", "West", "South"]
        });

        document.getElementById("active_room").innerHTML = direction;

        //Subbar till specifik kanal
        pubnub.subscribe({
          channels: [direction]
        });
      };

      sendMessage = e => {
        // Publish a simple message to the “demo_tutorial” channel pubnub:
        e.preventDefault();
        // let from = document.getElementById("from").value;
        let direction = document.getElementById("output").innerText;
        let message = document.getElementById("new-message").value;
        document.getElementById("david").innerHTML = direction;

        pubnub.publish({
          message: { from: username, message: message },
          channel: [direction]
        });
      };
    </script>

    <!-- Script för navigering av mobil, koodianater -->
    <script>
      // // Get event data
      function deviceOrientationListener(event) {
        let element = document.getElementById("orientation");
        // var alpha = event.alpha; //z axis rotation [0,360)
        // var beta = event.beta; //x axis rotation [-180, 180]
        // var gamma = event.gamma; //y axis rotation [-90, 90]
        element.innerHTML =
          "Alpha: " +
          event.alpha.toFixed([0]) +
          "<br/> Beta: " +
          event.beta.toFixed([0]) +
          "<br/> Gamma: " +
          event.gamma.toFixed([0]);

        var direction = document.getElementById("direction");

        if (event.alpha.toFixed([0]) > 315 || event.alpha.toFixed([0]) < 45) {
          direction.innerHTML = "North";
          subscribeToChannel("North");
        } else if (
          event.alpha.toFixed([0]) > 45 &&
          event.alpha.toFixed([0]) < 135
        ) {
          direction.innerHTML = "West";
          subscribeToChannel("West");
        } else if (
          event.alpha.toFixed([0]) > 135 &&
          event.alpha.toFixed([0]) < 225
        ) {
          direction.innerHTML = "South";
          subscribeToChannel("South");
        } else if (
          event.alpha.toFixed([0]) > 225 &&
          event.alpha.toFixed([0]) < 314
        ) {
          direction.innerHTML = "East";
          subscribeToChannel("East");
        }
      }

      if (window.DeviceOrientationEvent) {
        // alert("Works!");
        window.addEventListener(
          "deviceorientation",
          deviceOrientationListener,
          true
        );
      } else {
        alert("Doesn't work!");
      }
    </script>
    <!-- Slut på koden med navigeringen, (del 2 i labben) -->
  </head>

  <body ontouchstart="">
    <div id="firstpage">
      <h1>Welcome to Chat Along</h1>
      <h2>
        You join channels by pointing your mobilephone towards specific
        directions. <i>North, </i><i>East, </i><i>South, </i><i>West</i>
      </h2>
      <h4>Please enter username to start chatting</h4>
      <form onsubmit="enterChatroom(event)">
        <input
          type="text"
          placeholder="Enter username!"
          id="username"
          name="username"
        />
        <button type="submit">Select</button>
      </form>

      <pre>version 8</pre>
      <pre id="output">heh1</pre>
      <p id="david">david david</p>
      <p id="orientation"></p>
      <p id="direction"></p>
    </div>

    <div id="chatroom">
      <!--dkasjdkasjsdk -->
      <div id="room">
        <p>You're now in room:<i id="active_room"></i></p>
      </div>
      <h2>Messages:</h2>
      <form onsubmit="sendMessage(event)">
        <!-- <input type="text" placeholder="Who is sending the message?" name="from" id="from" /> -->
        <input
          type="text"
          placeholder="Write message!"
          name="new-message"
          id="new-message"
        />
        <button type="submit">
          Send message!
        </button>
      </form>

      <div id="messageDiv">
        <p id="messages"></p>
      </div>
    </div>

    <!-- <script src="cordova.js"></script>
                <script src="libs/evothings/evothings.js"></script>
                <script src="libs/evothings/ui/ui.js"></script> -->
  </body>
</html>
